### <a name="_b7urdng99y53"></a>__Название задачи:__ Открытие кредита онлайн

### <a name="_hjk0fkfyohdk"></a>__Автор:__ Архитектурная группа, Команда ИТ

### <a name="_uanumrh8zrui"></a>__Дата:__ 04.09.2025

### <a name="_3bfxc9a45514"></a>__Функциональные требования__

Опишите здесь верхнеуровневые Use Cases. Их нужно оформить в виде таблицы с пошаговым описанием:

|**№**|**Действующие лица или системы**|**Use Case**|**Описание**|
| :-: | :- | :- | :- |
| 1 | **Действующее лицо:** Новый клиент<br>**Системы:** Новое приложение интернет-банка, Кредитный конвейер, Система скоринга | Подача заявки на кредит новым клиентом через сайт | 1. Клиент на сайте (в гостевой зоне нового интернет-банка) выбирает опцию подачи заявки на кредит.<br>2. Клиент заполняет анкету, указывая Ф.И.О., номер телефона и паспортные данные (F10).<br>3. Система валидирует введенные данные.<br>4. Заявка отправляется в систему и асинхронно передается в Кредитный конвейер для дальнейшей обработки (F13).<br>5. Заявка не может быть переведена в финальный статус без офлайн идентификации клиента в соответствии с требованиями регулятора (+R3).  |
| 2 | **Действующее лицо:** Клиент Банка<br>**Системы:** Новое приложение интернет-банка, Кредитный конвейер, Система скоринга, АБС | Подача заявки на кредит существующим клиентом через интернет-банк | 1. Клиент авторизуется в интернет-банке.<br>2. Клиент выбирает доступный кредитный продукт из актуального списка (F9) или предодобренное предложение (F11).<br>3. Для предодобренного предложения запускается упрощенный повторный скоринг (F12).<br>4. Клиент подтверждает операцию с помощью СМС-кода (+R5).<br>5. Заявка передается в Кредитный конвейер для принятия решения (F13).<br>6. Система отправляет клиенту СМС-уведомление об изменении статуса заявки (F7).<br>7. Если менеджер в отделении начинает работать с заявкой, поданной онлайн, он должен видеть всю актуальную информацию в единой системе (+R11). |

### <a name="_u8xz25hbrgql"></a>__Нефункциональные требования__

Опишите здесь нефункциональные требования и архитектурно значимые требования.

|**№**|**Требование**|
| :-: | :- |
| R1 | Сервисы должны работать 24/7 и быть доступны в 99.99% случаев, что требует отказа от прямой интеграции с нестабильной АБС. |
| P1 | Отклик по всем операциям должен быть быстрым (в миллисекундах), что требует архитектуры, избегающей узких мест в виде перегруженной БД АБС. |
| P2 | Система должна выдерживать большую нагрузку от онлайн-заявок, что требует защиты АБС и системы скоринга от перегрузки. |
| +R1 | Система должна поддерживать горизонтальное масштабирование. |
| +R2 | Необходимо использовать Kafka для асинхронного обмена событиями. |
| +R7 | Реализовать централизованный сервис для управления ставками по всем продуктам (кредиты и депозиты), отказавшись от Excel-файлов. |
| +R8 | Необходима реализация промежуточного слоя для работы с АБС. Заявки должны передаваться в Кредитный конвейер не через АБС, а напрямую. |
| +R10 | Создать отдельный сервис для получения данных из Бюро кредитных историй для кеширования ответов и снижения нагрузки. |
| +R11 | Создать отдельный сервис для работы со кредитными заявками для обеспечения сквозного процесса. |

### <a name="_qmphm5d6rvi3"></a>__Решение__

Приведите диаграммы контекста и контейнеров в модели C4. Опишите там основные компоненты и интеграции всех элементов решения.

Для реализации функционала открытия кредита онлайн будет расширена существующая микросервисная архитектура, созданная в рамках MVP по открытию депозитов. Ключевым отличием от предыдущих этапов является внедрение централизованного сервиса управления ставками и внедрение более гибкой событийно-ориентированной модели.

1. [MVP3, C4 Context](../diagrams/to-be/mvp3_context.puml)
2. [MVP3, C4 Container](../diagrams/to-be/mvp3_container.puml)

Также опишите, какой логикой вы руководствовались в ходе принятия решений и выбора технологий. Не забывайте, что необходимо учесть все функциональные и нефункциональные требования.

**Логика решения:**


1. __Микросервис "Открытие кредитов онлайн"(новый):__ В соответствии с требованием (+R11), создается новый централизованный сервис для управления жизненным циклом кредитных заявок. Это решает проблему дублирования данных и обеспечивает сквозной процесс для всех каналов (сайт, интернет-банк, отделение). Сервис будет иметь собственную БД PostgreSQL.

2. __Микросервис "Управление ставками"(новый):__ В соответствии с требованием (+R7), создается новый сервис, который становится единственным источником правды для ставок и условий по всем продуктам (кредиты, депозиты). Он предоставляет API для других систем и заменяет ручной процесс работы с Excel-файлами.

3. __Микросервис "Скоринг"(новый):__ Изолированный сервис, который инкапсулирует логику взаимодействия с внешней скоринговой системой. Это позволяет управлять нагрузкой и кешировать результаты для предодобренных предложений, как того требует (P3).

4. __Микросервис "БКИ"(новый):__ В соответствии с требованием (+R10), создается сервис-прокси для работы с Бюро кредитных историй, что позволяет кешировать запросы и снизить зависимость от внешней системы.

5. __Микросервис "Уведомления"(новый)__: Специализированный сервис, который подписывается на события об изменении статусов заявок из Kafka. Он отвечает за сбор метаинформации из событий и отправку уведомлений (СМС, push) заинтересованным клиентам.

6. __Фасад АБС:__ Существующий ACL будет доработан для получения данных о клиентах и счетах, необходимых для кредитного процесса. 

7. __Kafka:__ Используется для асинхронной передачи статусов заявок между сервисами, что обеспечивает слабую связанность и гарантирует доставку уведомлений клиентам (F7) и передачу данных в другие системы.

**Обоснование**:

Данное решение логически развивает архитектуру, заложенную на предыдущих этапах. Оно полностью соответствует требованиям по надежности (R1), производительности (P1, P2) и масштабируемости (+R1) за счет изоляции систем друг от друга, использования асинхронных взаимодействий и создания защитных слоев (ACL, сервисы-прокси). Централизация работы с заявками в отдельных сервисах (+R11) является ключевым архитектурным решением, устраняющим дублирование и обеспечивающим единство процесса для всех каналов.

### <a name="_bjrr7veeh80c"></a>__Альтернативы__

Опишите здесь наиболее важные альтернативные решения.

1. **Реализация логики в существующем микросервисе "Открытие депозитов онлайн".**

   - __Описание:__ Вместо создания отдельных сервисов для кредитов, доработать существующий депозитный сервис.
   - __Причина отказа:__ Это привело бы к созданию большого модуля, отвечающего за разнородную бизнес-логику (депозиты и кредиты), что противоречит принципам микросервисной архитектуры (Single Responsibility Principle). Процессы обработки кредитов и депозитов слишком разные и требуют взаимодействия с разными внешними системами (Скоринг, БКИ).

2. **Прямая интеграция с Кредитным конвейером и скорингом.**

   - __Описание:__ Новые сервисы напрямую обращаются к API систем скоринга, БКИ и Кредитного конвейера.
   - __Причина отказа:__ Такая архитектура создает сильную связанность и делает систему уязвимой к сбоям или перегрузкам внешних систем (P3). Создание специализированных сервисов-прокси (+R10) для скоринга и БКИ позволяет кешировать данные, управлять нагрузкой и изолировать внутреннюю платформу от проблем внешних интеграций.

3. **Использование АБС как шины для передачи заявок.**
   - __Описание:__ Использовать существующий процесс передачи заявок в Кредитный конвейер через базу данных АБС.
   - __Причина отказа:__ Это решение прямо противоречит требованиям (R1, P1, +R8), так как АБС является перегруженной и немасштабируемой системой.  Передача данных раз в сутки (R4) недопустима для онлайн-процесса. Новая архитектура специально спроектирована для обхода этого "узкого горлышка".

4. **Создание единого "сервиса Заявок" для всех продуктов.**
   - __Описание:__ Реализовать центральный сервис, который бы хранил и управлял жизненным циклом всех заявок (депозиты, кредиты, и т.д.).
   - __Причина отказа:__ Данный подход является антипаттерном в микросервисной архитектуре. Бизнес-процессы обработки заявок на разные продукты (кредит и депозит) кардинально отличаются, требуют разного набора данных и взаимодействия с разными системами. Объединение их в один сервис привело бы к созданию "микро-монолита", который был бы сложен в поддержке, развитии и стал бы единой точкой отказа для несвязанных процессов.

**Недостатки, ограничения, риски**

Подробно опишите здесь недостатки, ограничения и риски выбранного решения.

- __Увеличение сложности системы:__ Добавление новых микросервисов увеличивает общую сложность архитектуры, требует более сложного мониторинга, развертывания и управления распределенными данными.
- __Оркестрация распределенных транзакций:__ Процесс выдачи кредита требует согласованного изменения данных в нескольких системах. Необходимо внедрять сложные паттерны, такие как Saga, для обеспечения конечной согласованности данных, что технически сложнее традиционных ACID-транзакций.
- __Зависимость от команды разработки ACL:__ Слой Anti-Corruption Layer становится еще более критичным компонентом, так как через него теперь работают и депозитные, и кредитные процессы.  Любые задержки в его доработке или сбои в его работе затронут несколько бизнес-линий.
- __Сложность сквозного тестирования:__ Проверка всего бизнес-процесса от подачи заявки на сайте до ее обработки в Кредитном конвейере требует координации развертывания и тестирования множества независимых сервисов, что усложняет CI/CD пайплайн.
- __Сложность сквозного мониторинга:__ Событийная архитектура требует продвинутых инструментов для трассировки запросов. Отследить путь одной заявки через несколько сервисов и топиков Kafka сложнее, чем при синхронных вызовах.
- __Гарантия доставки событий:__ Необходимо уделить особое внимание настройке Kafka и сервисов-продюсеров/консьюмеров, чтобы обеспечить гарантированную доставку и обработку событий для избежания потери информации о смене статуса.
- __Зависимость от доступности Kafka:__ Шина сообщений становится критически важным компонентом инфраструктуры. Ее недоступность остановит обработку всех заявок в системе.

