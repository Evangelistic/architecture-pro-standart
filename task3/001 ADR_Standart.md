### <a name="_b7urdng99y53"></a>__Название задачи:__ [MVP] Открытие депозита онлайн

### <a name="_hjk0fkfyohdk"></a>__Автор:__ Архитектурная группа, Команда ИТ

### <a name="_uanumrh8zrui"></a>__Дата:__ 03.09.2025

### <a name="_3bfxc9a45514"></a>__Функциональные требования__

Опишите здесь верхнеуровневые Use Cases. Их нужно оформить в виде таблицы с пошаговым описанием:

|**№**|**Действующие лица или системы**|**Use Case**|**Описание**|
| :-: | :- | :- | :- |
| 1 | **Действующее лицо:** Новый клиент<br>**Системы:** Новое приложение интернет-банка, Платформа CRM | Подача заявки на депозит новым клиентом через сайт | 1. Клиент в новом приложении интернет-банка(сайте) выбирает опцию подачи заявки на депозит.<br>2. Клиент заполняет форму, указывая Ф.И.О. и номер телефона (F2).<br>3. Система валидирует введенные данные.<br>4. Заявка отправляется в систему и асинхронно передается в систему кол-центра для дальнейшей обработки (F4).<br>5. Заявка не может быть переведена в финальный статус без офлайн идентификации клиента.  |
| 2 | **Действующее лицо:** Клиент Банка<br>**Системы:** Новое приложение интернет-банка | Открытие депозита существующим клиентом через интернет-банк | 1. Клиент авторизуется в интернет-банке.<br>2. Клиент выбирает доступный депозитный продукт из актуального списка (F1).<br>3. Клиент указывает сумму, счет списания и другие параметры депозита (F3).<br>4. Клиент подтверждает операцию с помощью СМС-кода (+R5).<br>5. Сотрудники бэк-офиса получают всю необходимую информацию и  взаимодействуя с АБС старым образом открывают депозит.<br>6. Система отправляет клиенту СМС-уведомление об успешном открытии депозита (F7). |

### <a name="_u8xz25hbrgql"></a>__Нефункциональные требования__

Опишите здесь нефункциональные требования и архитектурно значимые требования.

|**№**|**Требование**|
| :-: | :- |
| R1 | Сервисы должны работать 24/7 и быть доступны в 99.99% случаев, что требует отказа от прямой интеграции с нестабильной АБС. |
| P1 | Отклик по всем операциям должен быть быстрым (в миллисекундах), что требует архитектуры, избегающей узких мест в виде перегруженной БД АБС. |
| P2 | Система должна выдерживать большую нагрузку от онлайн-заявок, что требует защиты АБС от перегрузки. |
| +R1 | Система должна поддерживать горизонтальное масштабирование. |
| +R2 | Необходимо использовать Kafka для асинхронного обмена событиями. |
| +R8 | Необходима реализация промежуточного слоя (сервиса-адаптера) для работы с АБС, чтобы разгрузить ее и обеспечить отказоустойчивость. |
| S1 | Разработка должна вестись с использованием технологий, по которым есть экспертиза внутри банка. |

### <a name="_qmphm5d6rvi3"></a>__Решение__

Приведите диаграммы контекста и контейнеров в модели C4. Опишите там основные компоненты и интеграции всех элементов решения.

Для решения поставленной задачи выбрана микросервисная архитектура, развернутая в рамках новой банковской платформы приложеные диаграммы детально описывают структуру системы и ее окружение:

1. [C4 Context](../diagrams/to-be/mvp_context.puml)
2. [C4 Container](../diagrams/to-be/mvp_container.puml)

Также опишите, какой логикой вы руководствовались в ходе принятия решений и выбора технологий. Не забывайте, что необходимо учесть все функциональные и нефункциональные требования.

* **Single-Page App (SPA)**: Клиентский интерфейс, реализованный на React.js, который предоставляет весь новый функционал интернет-банка. В данный момент у банка существует два приложения, которые он вынужден поддерживать. Было принято использовать React.js, так как в банке уже есть экспертиза и на данном стеке можно построить клиентское приложение, которое будет поддерживать все необходимые платформы. Сайт будет реализован в Интернет-банке, через гостевой доступ с минимальным набором функций. (R1)
* **Backend For Frontend (BFF)**: Сервис на Java/Spring Boot, который служит для агрегации данных, получаемых от бэкенд-сервисов, и предоставления их в удобном виде для SPA, что сильно упростит взаимодействие между командами и позволит ускорить разработку в будущем. Также следует отметить что у нас строгие требования к производительности клиентского приложения и для того чтобы компенсировать накладные расходы за счет внедрения микросервисной архитектуры, необходимо внедрить BFF для ускорения как минимум самых тяжелых операций путем оптимизации данных на стороне сервера и их агрегации, кеширования. (P1)
* **API Gateway**: Единая точка входа для всех клиентских запросов. Обеспечивает маршрутизацию, безопасность и централизованное управление API. (P2)
* **Микросервис "Открытие депозитов онлайн"**: Изолированный микросервис на Java/Spring Boot, отвечающий за всю бизнес-логику, связанную с обработкой заявок и открытием депозитов. Он использует собственную базу данных PostgreSQL для хранения информации о заявках и статусах. (P1)
* **Anti-Corruption Layer (ACL) / Фасад АБС**: Ключевой компонент на Java/Spring Boot, который изолирует новую микросервисную платформу от унаследованной системы АБС. Он транслирует современные API-запросы в вызовы хранимых процедур PL/SQL в базе данных АБС. (+R8)
* **Kafka**: Шина сообщений, используемая для асинхронного взаимодействия между сервисами. Например, при подаче заявки новым клиентом API Gateway публикует событие в Kafka, которое затем обрабатывается микросервисом обработки заявок. Это позволит обеспечить необходимую отказоустойчивость даже при высоких нагрузках. (P2, +R1, +R2)
* **Микросервис обработки заявок**: Сервис, который подписывается на события о новых заявках из Kafka, обрабатывает их и передает в систему кол-центра для дальнейшей работы. (P2) Он служит мостом (интеграционным компонентом) между новой цифровой платформой и системой кол-центра для предобработки заявок от новых, еще не идентифицированных клиентов (+R3, F4).

1. **Надежность и Производительность (R1, P1, P2):** Прямая работа с АБС недопустима из-за ее перегруженности и невозможности горизонтального масштабирования. Внедрение **Anti-Corruption Layer (ACL)** в соответствии с требованием (+R8) создает защитный барьер, который позволяет управлять нагрузкой на АБС, кешировать данные и предотвращать каскадные сбои. Микросервисная архитектура позволяет независимо масштабировать компоненты для обработки пиковых нагрузок (+R1).
2. **Асинхронность и Отказоустойчивость (+R2):** Использование **Kafka** для обработки заявок от новых клиентов обеспечивает слабую связанность систем. Если система кол-центра временно недоступна, заявка не теряется, а остается в очереди и будет обработана позже. Это повышает общую надежность системы.
3. **Изоляция и Поддерживаемость (S1):** Разделение логики на отдельные микросервисы с собственными базами данных позволяет командам разрабатывать, тестировать и развертывать функционал независимо друг от друга, что ускоряет time-to-market. Выбор стека (Java/Spring Boot) соответствует требованию об использовании технологий с имеющейся экспертизой.

### <a name="_bjrr7veeh80c"></a>__Альтернативы__

Опишите здесь наиболее важные альтернативные решения.

1. **Модификация существующего монолита АБС.**
   * **Описание:** Реализация всего нового функционала непосредственно в унаследованной системе АБС.
   * **Причина отказа:** Данный вариант был отклонен, так как АБС уже перегружена, не способна к горизонтальному масштабированию и ее модификация является медленным и рискованным процессом. Это решение прямо противоречит требованиям по надежности (R1), производительности (P1, P2) и масштабируемости (+R1).

2. **Прямая интеграция с АБС без Anti-Corruption Layer.**
   * **Описание:** Новые микросервисы напрямую обращаются к базе данных или процедурам АБС.
   * **Причина отказа:** Такая архитектура привела бы к сильной связанности между новой платформой и унаследованной системой. Все проблемы АБС (нестабильность, медленная работа) напрямую транслировались бы на новые сервисы, что делает невозможным выполнение требований R1 и P1. Это нарушает требование (+R8) о создании промежуточного слоя.

3. **Использование только синхронных взаимодействий (REST).**
   * **Описание:** Отказ от использования Kafka и реализация всех взаимодействий (например, передача заявки в кол-центр) через прямые синхронные REST-вызовы.
   * **Причина отказа:** Этот вариант противоречит прямому требованию (+R2) об использовании Kafka. Кроме того, он снижает отказоустойчивость системы: при временной недоступности системы кол-центра заявка от нового клиента была бы потеряна. Асинхронный подход с очередью сообщений обеспечивает гарантированную доставку.

**Недостатки, ограничения, риски**

Подробно опишите здесь недостатки, ограничения и риски выбранного решения.

* **Повышенная сложность:** Микросервисная архитектура значительно сложнее монолитной. Возникают новые проблемы: управление распределенными транзакциями, сквозной мониторинг и трассировка запросов, сложность локального развертывания для разработки и тестирования.
* **Операционные издержки:** Поддержка и мониторинг множества сервисов, баз данных, а также кластера Kafka требует более высокой квалификации команды DevOps и увеличивает операционные расходы по сравнению с поддержкой одного монолитного приложения.
* **Сетевые задержки:** Взаимодействие между сервисами происходит по сети, что вносит дополнительные задержки по сравнению с вызовами внутри одного процесса в монолите.
* **Конечная согласованность данных:** В асинхронных сценариях, использующих Kafka (например, обработка заявки нового клиента), система достигает согласованного состояния не мгновенно. Это требует внедрения паттернов для управления распределёнными транзакциями (например, Saga).
* **ACL как единая точка отказа для Legacy:** Anti-Corruption Layer становится критически важным компонентом для взаимодействия с унаследованными данными. Его сбой приведет к недоступности всех функций, зависящих от АБС.

